#!/usr/bin/env bash

arrow() {
  sed -u 's/^/-----> /'
}

# installing libreoffice

echo "installing Libreoffice" | arrow

set -e

BUILD_DIR=$1
CACHE_DIR=$2
APT_DIR=$BUILD_DIR/.apt

echo "LibreOffice: Setting PATH" | arrow
PROFILE_PATH="$BUILD_DIR/.profile.d/libreoffice.sh"
mkdir -p $(dirname $PROFILE_PATH)

# Add vendor binaries to the path
echo 'export OFFICE_PATH="$HOME/.apt/usr/lib/libreoffice"' >> $PROFILE_PATH

cd $APT_DIR/usr/lib/x86_64-linux-gnu/
ln -sv mesa/libGL.so.1 .

cd $APT_DIR/usr/lib/x86_64-linux-gnu
ln -sv ../libreoffice/program/* .

echo "Installing unoconv 0.8 from https://github.com/dagwieers/unoconv" | arrow
cd $1
mkdir -p vendor/unoconv
curl -s https://raw.githubusercontent.com/dagwieers/unoconv/0.8/unoconv > vendor/unoconv/unoconv
chmod 775 vendor/unoconv/unoconv

# update PATH and LD_LIBRARY_PATH
echo "Updating environment variables" | arrow
PROFILE_PATH="$BUILD_DIR/.profile.d/unoconv.sh"
ACTUAL_INSTALL_PATH="$HOME/vendor/unoconv"
mkdir -p $(dirname $PROFILE_PATH)
echo "export PATH=$ACTUAL_INSTALL_PATH/bin:\$PATH" >> $PROFILE_PATH
echo "export LD_LIBRARY_PATH=$HOME/.apt/usr/lib/libreoffice" >> $PROFILE_PATH
echo "export UNOCONV_CONFIGURE_PATH=$ACTUAL_INSTALL_PATH" >> $PROFILE_PATH
echo "export PYTHONPATH=$HOME/../usr/lib/python3.5" >> $PROFILE_PATH
#echo "export PYTHONHOME=$HOME/../usr/lib/python3.5" >> $PROFILE_PATH
echo "export UNO_PATH=$HOME/.apt/usr/lib/libreoffice/program" >> $PROFILE_PATH